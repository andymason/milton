(()=>{var F=Object.assign;var P;(function(e){e[e.CHOOSE_FRAMES=0]="CHOOSE_FRAMES",e[e.RESPONSIVE_PREVIEW=1]="RESPONSIVE_PREVIEW",e[e.SAVE_OUTPUT=2]="SAVE_OUTPUT"})(P||(P={}));var p;(function(e){e[e.FOUND_FRAMES=0]="FOUND_FRAMES",e[e.NO_FRAMES=1]="NO_FRAMES",e[e.RENDER=2]="RENDER",e[e.CLOSE=3]="CLOSE",e[e.ERROR=4]="ERROR",e[e.UPDATE_HEADLINES=5]="UPDATE_HEADLINES",e[e.COMPRESS_IMAGE=6]="COMPRESS_IMAGE",e[e.GET_ROOT_FRAMES=7]="GET_ROOT_FRAMES"})(p||(p={}));var k;(function(e){e[e.INLINE=0]="INLINE",e[e.IFRAME=1]="IFRAME"})(k||(k={}));var f;(function(e){e.HEADLINE="headline",e.SUBHEAD="subhead",e.SOURCE="source"})(f||(f={}));class ${constructor(e){this.TIMEOUT=3e4;this.receive=async e=>{var r;const s=this.inFigmaSandbox?e:(r=e==null?void 0:e.data)==null?void 0:r.pluginMessage,{data:n,workload:i,name:a,uid:t,returning:l,err:c}=s||{};try{if(this.name!==a)return;if(l&&!this.callbackStore[t])throw new Error(`Missing callback: ${t}`);if(!l&&!this.workers[i])throw new Error(`No workload registered: ${i}`);if(l)this.callbackStore[t](n,c);else{const o=await this.workers[i](n);this.postBack({data:o,uid:t})}}catch(o){this.postBack({uid:t,err:"Postman failed"}),console.error("Postman failed",o)}};this.registerWorker=(e,s)=>{this.workers[e]=s};this.postBack=e=>this.postMessage({name:this.name,uid:e.uid,data:e.data,returning:!0,err:e.err});this.postMessage=e=>this.inFigmaSandbox?figma.ui.postMessage(e):parent.postMessage({pluginMessage:e},"*");this.send=e=>new Promise((s,n)=>{const{workload:i,data:a}=e,t=Math.random().toString(36).substr(5);this.postMessage({name:this.name,uid:t,workload:i,data:a}),this.callbackStore[t]=(l,c)=>{c?n(c):s(l)},setTimeout(()=>n(new Error("Timed out")),this.TIMEOUT)});this.name=(e==null?void 0:e.messageName)||"POSTMAN",this.inFigmaSandbox=typeof figma=="object",this.callbackStore={},this.workers={},this.inFigmaSandbox?figma.ui.on("message",this.receive):window.addEventListener("message",this.receive)}}const I=new $;function T(e,s){const n=e.findChild(i=>i.name===s);return n&&n.type==="TEXT"?n.characters:void 0}var u;(function(e){e[e.LETTER_SPACING=0]="LETTER_SPACING",e[e.LINE_HEIGHT=1]="LINE_HEIGHT",e[e.FONT_SIZE=2]="FONT_SIZE",e[e.COLOUR=3]="COLOUR",e[e.FONT=4]="FONT"})(u||(u={}));function R(e,s,n,i){switch(s){case 0:{const a=e.getRangeLetterSpacing(n,i);return a===figma.mixed?a:a.unit==="PERCENT"?`${a.value/100}rem`:`${a.value}px`}case 1:{const a=e.getRangeLineHeight(n,i);return a===figma.mixed?a:a.unit==="AUTO"?"normal":a.unit==="PERCENT"?`${a.value/100}rem`:`${a.value}px`}case 2:return e.getRangeFontSize(n,i);case 3:{const a=e.getRangeFills(n,i);return a===figma.mixed?a:a[0].type==="SOLID"?F({},a[0].color):{r:0,g:0,b:0}}case 4:return e.getRangeFontName(n,i);default:return}}function y(e,s){const{characters:n}=e,i=R(e,s,0,n.length);if(i!==figma.mixed)return[{start:0,end:n.length,value:i}];const a=[{start:0,end:1,value:R(e,s,0,1)}];for(let t=1;t<=n.length;t++){const l=a[a.length-1];l.end=t;const c=R(e,s,l.start,t);c===figma.mixed&&(l.end=t-1,a.push({start:t,end:t+1,value:R(e,s,t-1,t)}))}return a}function w(e,s,n){return e.find(i=>s>=i.start&&n<=i.end)}function z(e){var l,c,r,o,d;const{characters:s}=e,n={letterSpace:y(e,0),lineHeight:y(e,1),size:y(e,2),colour:y(e,3),font:y(e,4)},i=Object.values(n).flatMap(m=>m.map(g=>g.end)).sort((m,g)=>m>g?1:-1).filter((m,g,x)=>x.indexOf(m)===g),a=[];let t=0;for(let m of i){t===m&&m++;const g={start:t,end:m,chars:s.substring(t,m),font:(l=w(n.font,t+1,m))==null?void 0:l.value,colour:(c=w(n.colour,t+1,m))==null?void 0:c.value,size:(r=w(n.size,t+1,m))==null?void 0:r.value,letterSpace:(o=w(n.letterSpace,t+1,m))==null?void 0:o.value,lineHeight:(d=w(n.lineHeight,t+1,m))==null?void 0:d.value};a.push(g),t=m}return a}function C(e){const s=e.findAll(l=>l.type==="TEXT"&&l.characters.length>0),{absoluteTransform:n}=e,i=n[0][2],a=n[1][2],t=[];for(const l of s){const{absoluteTransform:c,width:r,height:o,characters:d,textAlignHorizontal:m,textAlignVertical:g,constraints:x,strokes:h,strokeWeight:E,id:U}=l;console.log(h,E);let O={};const S=h.find(v=>v.type==="SOLID");S&&(O={strokeWeight:E,strokeColour:`rgb(${Object.values(S.color).map(v=>v*255).join(",")})`});const D=c[0][2],V=c[1][2],M=D-i,W=V-a,B=z(l);t.push(F({x:M,y:W,width:r,height:o,characters:d,textAlignHorizontal:m,textAlignVertical:g,constraints:x,rangeStyles:B,id:U},O))}return t}function b(e){return e.type!=="SLICE"&&e.type!=="GROUP"}async function A(e){const s=figma.createFrame();s.name="output";try{const n=figma.currentPage.findAll(({id:r})=>e.includes(r)),i=Math.max(...n.map(r=>r.width)),a=Math.max(...n.map(r=>r.height));s.resizeWithoutConstraints(i,a);for(const r of n){const o=r==null?void 0:r.clone();s.appendChild(o),o.x=0,o.y=0,o.name=r.id}const t=s.findAll(r=>b(r)&&r.fills!==figma.mixed&&r.fills.some(o=>o.type==="IMAGE")),l={};for(const r of t)if(b(r)&&r.fills!==figma.mixed){const o={width:r.width,height:r.height,id:r.id},d=[...r.fills].find(m=>m.type==="IMAGE");(d==null?void 0:d.type)==="IMAGE"&&d.imageHash&&(l[d.imageHash]?l[d.imageHash].push(o):l[d.imageHash]=[o])}for(const r in l){const o=await figma.getImageByHash(r).getBytesAsync(),d=await I.send({workload:p.COMPRESS_IMAGE,data:{imgData:o,nodeDimensions:l[r]}}),m=figma.createImage(d).hash;t.forEach(g=>{if(b(g)&&g.fills!==figma.mixed){const x=[...g.fills].find(h=>h.type==="IMAGE"&&h.imageHash===r);if(x){const h=JSON.parse(JSON.stringify(x));h.imageHash=m,g.fills=[h]}}})}await new Promise(r=>setTimeout(r,300));const c=await s.exportAsync({format:"SVG",svgSimplifyStroke:!0,svgOutlineText:!1,svgIdAttribute:!0});return c}catch(n){throw new Error(n)}finally{s.remove()}}function H(e){const s=figma.currentPage,n=Math.min(...s.children.map(a=>a.x)),i=Math.min(...s.children.map(a=>a.y));for(const a of Object.values(f)){let t=s.findChild(o=>o.name===a&&o.type==="TEXT")||null;const l=e[a];if(t&&!l){t.remove();return}if(!l)return;if(!t){t=figma.createText(),t.name=a;let o=i-60;a===f.HEADLINE?o-=60:a===f.SUBHEAD&&(o-=30),t.relativeTransform=[[1,0,n],[0,1,o]]}t.locked=!0;const c=t.fontName!==figma.mixed?t.fontName.family:"Roboto",r=t.fontName!==figma.mixed?t.fontName.style:"Regular";figma.loadFontAsync({family:c,style:r}).then(()=>{t.characters=e[a]||""}).catch(o=>{console.error("Failed to load font",o)})}}function L(){const{currentPage:e}=figma;let s=e.selection.filter(i=>i.type==="FRAME");s.length===0&&(s=e.children.filter(i=>i.type==="FRAME"));const n=s.map(i=>{const{name:a,width:t,height:l,id:c}=i,r=C(i),o=i.children.slice(i.children.length-i.numberOfFixedChildren).map(d=>d.id);return{name:a,width:t,height:l,id:c,textNodes:r,fixedPositionNodes:o}});return{frames:n,headline:T(e,f.HEADLINE),subhead:T(e,f.HEADLINE),source:T(e,f.HEADLINE)}}I.registerWorker(p.GET_ROOT_FRAMES,L);I.registerWorker(p.RENDER,A);I.registerWorker(p.UPDATE_HEADLINES,H);figma.showUI(__html__);const{width:X,height:_}=figma.viewport.bounds,{zoom:N}=figma.viewport,Z=Math.round(X*N),j=Math.round(_*N);figma.ui.resize(Z,j);})();
